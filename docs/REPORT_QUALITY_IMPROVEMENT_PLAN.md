# レポート品質改善計画

## 作成日
2025-12-10（草案・要更新）

## 目的
現在のレポート生成システムの品質を向上させるため、問題点を明確化し、具体的な改善策を提案する。

## 前提
- 実行環境: ローカルLLMを使用（APIコストなし）、日本語メイン
- 方針: 精度を優先し、必要な文脈は長めに保持。トークン上限に近づいた場合のみ縮約するフェイルセーフを使う（最適化は「落とす」のではなく「落ちないように」）。

---

## 1. 現状の問題点分析

### 1.1 判断理由の保存・活用不足

#### 問題の詳細
- **現状**: プロンプト（`theme_extraction.py`）では `importance_reason` と `relevance_reason` の生成を指示しているが、データベースに保存されていない
- **影響**: 
  - 深掘り検索で判断理由を活用できない
  - レポート生成時に判断理由が含まれない
  - 分析→深掘り→レポートの連携が弱い

#### 実装上の問題
1. **データベーススキーマ**: `article_analysis` テーブルに `importance_reason` と `relevance_reason` カラムが存在しない
2. **保存処理**: `save_analysis()` メソッドで判断理由を保存していない
3. **取得処理**: `analyze_pending.py` で判断理由を取得しているが、保存時に無視されている

#### 実際のレポートでの影響例
- **LHCレポート**: 重要度0.80、関連度0.10の理由が記載されていない
- **MetaとGoogleレポート**: 重要度0.85、関連度0.92の理由が記載されていない
- レポート読者は「なぜこのスコアなのか」を理解できない

---

### 1.2 検索クエリ生成の精度不足

#### 問題の詳細
- **現状**: 検索クエリ生成プロンプト（`search_query_gen.py`）に判断理由が含まれていない
- **影響**: 
  - 適切な検索クエリが生成されない
  - 検索結果が元の記事と関連性が低い

#### 実際のレポートでの問題例

**例1: MetaとGoogleのLLM限界説検証**
- **元記事**: MetaとGoogleの研究者がLLM限界説を検証したという報道
- **検索結果**: 「Metaの語源・社名変更・メタゲーム・メタ分析」など全く関係ない情報
- **原因**: 検索クエリ生成時に「なぜ重要と判断されたか」が考慮されていない

**例2: LHCのマジック現象**
- **元記事**: LHCで「マジック現象」が検出されたという報道
- **検索結果**: LHCの基本的な原理や一般的な議論のみで、具体的な実験データや論文が見つからない
- **原因**: 深掘りすべきポイント（実験データ、論文、検証方法）が明確化されていない

#### 実装上の問題
1. **プロンプト設計**: `search_query_gen.build_prompt()` に判断理由が含まれていない
2. **データ取得**: `deep_research.py` で判断理由を取得していない
3. **コンテキスト不足**: 元の記事の要点や分析結果が検索クエリ生成に活用されていない

---

### 1.3 検索結果統合の不十分さ

#### 問題の詳細
- **現状**: 検索結果統合プロンプト（`result_synthesis.py`）に元の分析結果が含まれていない
- **影響**: 
  - 検索結果が元の記事と関連性が低い場合でも、適切に評価されない
  - 深掘り調査の価値が明確化されない

#### 実装上の問題
1. **プロンプト設計**: `result_synthesis.build_prompt()` に元の分析結果（重要度・関連度・判断理由）が含まれていない
2. **コンテキスト不足**: 元の記事の要点や分析結果が統合プロセスに活用されていない
3. **評価基準の欠如**: 検索結果が元の記事の主張を裏付けるかどうかの評価基準が不明確

---

### 1.4 記事内容の切り詰め

#### 問題の詳細
- **現状**: 分析時に記事の最初の2000文字のみ使用（`theme_extraction.py` の `content[:2000]`）
- **影響**: 
  - 記事の重要な情報が後半にある場合、分析精度が低下する
  - 長文記事の分析が不十分になる可能性

#### 実装上の問題
1. **固定長切り詰め**: 記事の構造を考慮せず、単純に先頭2000文字を切り取っている
2. **代替手段なし**: 要約や重要箇所抽出などの前処理がない

---

### 1.5 レポート生成での情報不足

#### 問題の詳細
- **現状**: レポート生成プロンプト（`theme_report.py`）に判断理由が含まれていない
- **影響**: 
  - レポートに判断理由が記載されない
  - 読者が「なぜこの記事が重要と判断されたか」を理解できない

#### 実装上の問題
1. **プロンプト設計**: `theme_report.build_prompt()` に判断理由が含まれていない
2. **データ取得**: `fetch_deep_research_by_theme()` で判断理由を取得していない
3. **情報の欠落**: 分析→深掘り→レポートの連携が弱い

---

## 2. 改善提案

### 2.1 データベーススキーマの拡張

#### 変更内容
```sql
ALTER TABLE article_analysis ADD COLUMN importance_reason TEXT;
ALTER TABLE article_analysis ADD COLUMN relevance_reason TEXT;
```

#### 実装ファイル
- `lifelog-system/src/info_collector/repository.py`
  - `_init_tables()` メソッドを修正
  - 既存データベースへのマイグレーション処理を追加
  - 手順: DBバックアップ → ALTER → アプリ再起動 → （任意）過去記事を再分析してバックフィル

#### 期待効果
- 判断理由を永続化できる
- 後続の深掘り検索やレポート生成で活用できる

---

### 2.2 分析結果の保存強化

#### 変更内容
1. **`save_analysis()` メソッドの拡張**
   - `importance_reason` と `relevance_reason` パラメータを追加
   - データベースへの保存処理を追加
   - `None` や欠損時は空文字など安全なデフォルトで保存

2. **`analyze_pending.py` の修正**
   - LLMから取得した判断理由を保存処理に渡す
   - LLM応答のJSONバリデーションと再実行/フェイルセーフを実装

#### 実装ファイル
- `lifelog-system/src/info_collector/repository.py`
- `lifelog-system/src/info_collector/jobs/analyze_pending.py`

#### 期待効果
- 判断理由がデータベースに保存される
- 後続の処理で判断理由を活用できる

---

### 2.3 検索クエリ生成の強化

#### 変更内容
1. **プロンプトの拡張**
   - 判断理由をプロンプトに含める
   - 元の記事の要点を明確化する
   - クエリ本数を2-3本生成し、同義語・英訳も含む（日本語の表記揺れ対策）
   - 必要な文脈は可能な限り保持し、トークン上限に近づいた場合のみ縮約するフェイルセーフを入れる

2. **データ取得の拡張**
   - `fetch_deep_research_targets()` で判断理由を取得
   - `deep_research.py` で判断理由をプロンプトに渡す

3. **検索戦略**
   - 検索結果が薄い場合はリトライクエリを使う
   - 期間フィルタ・サイト多様性（同一ドメイン過多を防ぐ）を指示
   - 取得結果はBM25/ベクトルで再ランキングしてからLLMに渡す

#### 実装ファイル
- `lifelog-system/src/info_collector/prompts/search_query_gen.py`
- `lifelog-system/src/info_collector/repository.py`
- `lifelog-system/src/info_collector/jobs/deep_research.py`

#### プロンプト改善例
```python
USER_PROMPT_TEMPLATE = """以下のテーマについて、深掘り調査用の検索クエリを生成してください。

【テーマ】
{theme}

【キーワード】
{keywords}

【カテゴリ】
{category}

【記事要約】
{summary}

【重要度判断理由】
{importance_reason}

【関連度判断理由】
{relevance_reason}

【深掘りすべきポイント】
上記の判断理由を踏まえ、以下の観点から深掘りすべきポイントを特定してください：
1. 元の記事の主張を裏付ける証拠やデータ
2. 関連する学術論文や公式発表
3. 業界専門家の見解や分析
4. 類似事例や比較対象
5. 今後の動向や影響

上記の出力形式に従ってJSON出力してください。"""
```

#### 期待効果
- より適切な検索クエリが生成される
- 検索結果が元の記事と関連性が高くなる
- 深掘り調査の精度が向上する

---

### 2.4 検索結果統合の強化

#### 変更内容
1. **プロンプトの拡張**
   - 元の分析結果（重要度・関連度・判断理由）をプロンプトに含める
   - 元の記事の要点を明確化する
   - 最低出典数（例:3件）、一次情報優先、発表日/出典を必ず明記
   - 矛盾があれば「矛盾あり/未確認」と明記し幻覚防止の否定指示を入れる
   - 検索結果全文を渡すことを優先し、長さ超過時のみ縮約する

2. **データ取得の拡張**
   - `deep_research.py` で元の分析結果を取得
   - 統合プロンプトに元の分析結果を渡す

#### 実装ファイル
- `lifelog-system/src/info_collector/prompts/result_synthesis.py`
- `lifelog-system/src/info_collector/jobs/deep_research.py`

#### プロンプト改善例
```python
USER_PROMPT_TEMPLATE = """以下の検索結果を統合して要約してください。

【元のテーマ】
{theme}

【元の記事の要点】
{article_summary}

【重要度・関連度スコア】
- 重要度: {importance_score} ({importance_reason})
- 関連度: {relevance_score} ({relevance_reason})

【検索クエリ】
{search_query}

【検索結果】
{search_results}

【統合の観点】
1. 検索結果が元の記事の主張を裏付けるかどうか
2. 元の記事で不足していた情報が補完されているか
3. 検索結果と元の記事の間に矛盾がないか
4. 深掘り調査で得られた新規性や価値

上記の出力形式に従ってJSON出力してください。"""
```

#### 期待効果
- 検索結果が元の記事と関連性が低い場合でも、適切に評価される
- 深掘り調査の価値が明確化される
- レポート生成時の情報が充実する

---

### 2.5 記事内容の処理改善

#### 変更内容
1. **要約生成の追加**
   - 長文記事の場合は、LLMで要約を生成してから分析
   - または、記事の構造を考慮した重要箇所抽出
   - スライディングウィンドウ/見出し分割で要約し、プロンプト長を抑える
    - 可能な限り本文を保持し、トークン上限に近づいた場合のみ圧縮する

2. **段階的分析**
   - まず全体を要約
   - 要約から重要箇所を特定
   - 重要箇所を詳細分析

#### 実装ファイル
- `lifelog-system/src/info_collector/jobs/analyze_pending.py`
- `lifelog-system/src/info_collector/prompts/theme_extraction.py`

#### 改善案
```python
def build_prompt(title: str, content: str, published_at: str) -> dict[str, str]:
    # 長文の場合は要約を生成
    if len(content) > 2000:
        # 要約生成プロンプト
        summary_prompt = f"""
        以下の記事を300-500文字で要約してください。
        重要な情報（数値、日付、人名、技術名など）は必ず含めてください。
        
        タイトル: {title}
        本文: {content}
        """
        # LLMで要約を生成（実装が必要）
        # content = generate_summary(summary_prompt)
        # 暫定的に、先頭と末尾を結合
        content = content[:1000] + "\n...\n" + content[-1000:]
    
    return {
        "system": SYSTEM_PROMPT,
        "user": USER_PROMPT_TEMPLATE.format(
            title=title,
            content=content,
            published_at=published_at,
        ),
    }
```

#### 期待効果
- 長文記事の分析精度が向上する
- 重要な情報が欠落しにくくなる

---

### 2.6 レポート生成の強化

#### 変更内容
1. **プロンプトの拡張**
   - 判断理由をプロンプトに含める
   - 分析→深掘り→レポートの連携を明確化
   - 出典リンク、確信度、未解決点/残課題をテンプレに含める
   - 各理由・要約の文字数上限は緩めに設定し、上限超過時のみトリミング

2. **データ取得の拡張**
   - `fetch_deep_research_by_theme()` で判断理由を取得
   - レポート生成プロンプトに判断理由を渡す

#### 実装ファイル
- `lifelog-system/src/info_collector/prompts/theme_report.py`
- `lifelog-system/src/info_collector/repository.py`
- `lifelog-system/src/info_collector/jobs/generate_theme_report.py`

#### プロンプト改善例
```python
# 記事詳細をフォーマット
article_details = ""
for idx, article in enumerate(articles, 1):
    article_details += f"\n### 記事 {idx}: {article.get('article_title', 'N/A')}\n"
    article_details += f"- **URL**: {article.get('article_url', 'N/A')}\n"
    article_details += f"- **重要度**: {article.get('importance_score', 0):.2f}\n"
    article_details += f"  - **判断理由**: {article.get('importance_reason', 'N/A')}\n"
    article_details += f"- **関連度**: {article.get('relevance_score', 0):.2f}\n"
    article_details += f"  - **判断理由**: {article.get('relevance_reason', 'N/A')}\n"
    # ... 以下既存のコード
```

#### 期待効果
- レポートに判断理由が記載される
- 読者が「なぜこの記事が重要と判断されたか」を理解できる
- レポートの信頼性が向上する

---

### 2.7 評価・テスト基盤の整備

#### 変更内容
- 日本語ゴールデン記事セット（10-20本）を用意し、分析→検索→統合→レポートまでのJSON出力をスナップショットして回帰テスト
- 指標例:
  - クエリ関連度@n（簡易BM25スコア or 人手ラベル）
  - 検索結果の新規性/重複率、一次情報率、出典数
  - レポート内の事実一致率（少数サンプルで手動検証）
  - 推論時間とトークン消費（プロンプト/レスポンス）
- プロンプト変更時はAB比較（旧版 vs 新版）を週次で実施し、改善が出たらバージョン固定

#### 実装ファイル候補
- `tests/` 以下にE2E回帰スクリプトを追加
- 既存ジョブのログをJSON出力して比較できるようにする

#### 期待効果
- 改善の有無を定量で把握できる
- プロンプト変更による品質劣化を早期検知できる

---

### 2.8 パフォーマンス・コスト・運用

#### 変更内容
- モデル粒度: 軽量モデルで検索クエリ生成、重いモデルは統合/レポートのみ
- SLO目安: 分析≦2s、統合≦5s/件（超過時は簡易モードへフェイルバック）
- プロンプト長方針: 必要文脈は保持し、トークン上限に近づいた場合のみ縮約するフェイルセーフを入れる（短文化は最後の手段）
- キャッシュ: 同一URLの再分析・再検索を一定期間スキップ、深掘り対象はスコア上位に限定
- ログ/メトリクス: スコア分布、処理時間、失敗率、トークン数を収集し、閾値超過でアラート

#### 実装ファイル候補
- `lifelog-system/src/info_collector/jobs/*`
- `lifelog-system/src/info_collector/search/`（再ランキング/キャッシュ）

#### 期待効果
- ローカルLLMでの計算コストを抑えつつ品質を維持
- 運用時の性能劣化や失敗を可視化・早期検知できる

---

## 3. 実装優先順位

### 優先度1: 高（即座に実装すべき）
1. **データベーススキーマの拡張**（2.1）
2. **分析結果の保存強化**（2.2）
3. **検索クエリ生成の強化**（2.3）
4. **評価・テスト基盤の整備（最低限のゴールデンセットと回帰スクリプト）**（2.7）

### 優先度2: 中（早期に実装すべき）
5. **検索結果統合の強化**（2.4）
6. **レポート生成の強化**（2.6）

### 優先度3: 低（将来的に検討）
7. **記事内容の処理改善**（2.5）
8. **パフォーマンス・コスト・運用のチューニング高度化**（2.8）

---

## 4. 期待される改善効果

### 4.1 検索クエリ生成の精度向上
- **現状**: 関連性の低い検索結果が返ってくる
- **改善後**: 元の記事の要点や判断理由を踏まえた適切な検索クエリが生成される
- **指標**: クエリ関連度@n（BM25スコア/人手ラベル）向上、ヒット率改善、再検索発生率の低下

### 4.2 深掘り調査の価値向上
- **現状**: 検索結果が元の記事と関連性が低い場合でも、適切に評価されない
- **改善後**: 元の分析結果を踏まえた統合により、深掘り調査の価値が明確化される
- **指標**: 一次情報率/出典数増加、矛盾検知率向上、統合結果の人手評価スコア向上

### 4.3 レポートの信頼性向上
- **現状**: 判断理由が記載されず、読者が「なぜ重要と判断されたか」を理解できない
- **改善後**: 判断理由が明確に記載され、レポートの信頼性が向上する
- **指標**: 出典リンク数/一次情報率、事実一致率（スポットチェック）、読了率/フィードバック

### 4.4 分析→深掘り→レポートの連携強化
- **現状**: 各段階が独立しており、連携が弱い
- **改善後**: 各段階で前段階の結果を活用し、一貫性のある情報処理が実現される
- **指標**: パイプライン全体のE2E成功率、処理時間SLO遵守率、スコア伝播の欠損率低下

---

## 5. 実装時の注意点

### 5.1 既存データベースへの影響
- 既存の `article_analysis` テーブルにカラムを追加する際は、マイグレーション処理が必要
- 既存データの `importance_reason` と `relevance_reason` は `NULL` になる
- 必要に応じて、既存データの再分析を検討

### 5.2 後方互換性
- 既存のコードが判断理由を取得していない場合、`None` や空文字列を返すようにする
- プロンプト生成時に判断理由が `None` の場合は、デフォルトメッセージを使用
- プロンプト長の上限管理を行い、トークン超過時は要約/トリミングで縮約する（情報欠損時はその旨を明示）

### 5.3 パフォーマンス
- 判断理由の追加により、データベースのサイズが増加する可能性がある
- 検索クエリ生成や統合処理のプロンプトが長くなるため、LLMの処理時間が増加する可能性がある
- 必要に応じて、プロンプトの最適化を検討
- SLO超過時のフェイルバック（簡易モード/出典数絞り込み）を用意する

---

## 6. テスト計画

### 6.1 単体テスト
- `save_analysis()` メソッドで判断理由が正しく保存されることを確認
- `fetch_deep_research_targets()` で判断理由が正しく取得されることを確認
- 各プロンプト生成メソッドで判断理由が正しく含まれることを確認
- LLM応答のJSONバリデーションと欠損時のデフォルト処理を確認

### 6.2 統合テスト
- 分析→深掘り→レポート生成の一連の流れで、判断理由が正しく伝播されることを確認
- 既存データベースへのマイグレーションが正しく動作することを確認
- ゴールデン記事セットでE2Eを回し、旧版と新版の出力差分を比較

### 6.3 品質テスト
- 改善後のレポートと改善前のレポートを比較し、品質向上を確認
- 検索結果の関連性スコアが向上していることを確認
- 人手スポットチェックで事実一致率と読みやすさを評価

### 6.4 モニタリング/運用
- スコア分布、処理時間、失敗率、トークン数をログ/ダッシュボードで可視化
- 閾値超過時にアラート（例: E2E失敗率増加、処理時間SLO超過）

---

## 7. 参考資料

### 7.1 関連ファイル
- `lifelog-system/src/info_collector/prompts/theme_extraction.py`
- `lifelog-system/src/info_collector/prompts/search_query_gen.py`
- `lifelog-system/src/info_collector/prompts/result_synthesis.py`
- `lifelog-system/src/info_collector/prompts/theme_report.py`
- `lifelog-system/src/info_collector/jobs/analyze_pending.py`
- `lifelog-system/src/info_collector/jobs/deep_research.py`
- `lifelog-system/src/info_collector/jobs/generate_theme_report.py`
- `lifelog-system/src/info_collector/repository.py`

### 7.2 実際のレポート例
- `lifelog-system/data/reports/article_LHCで新たなマジック現象を検出_2025-12-10.md`
- `lifelog-system/data/reports/article_MetaとGoogleの研究者がLLM限界説の真偽を検証_2025-12-10.md`
- `lifelog-system/data/reports/article_Poetiq_releases_new_SOTA_on_ARC_AGI_12_2025-12-10.md`

---

## 8. 今後の検討事項

### 8.1 記事内容の処理改善
- 長文記事の要約生成機能の実装
- 記事の構造を考慮した重要箇所抽出機能の実装

### 8.2 検索クエリ生成の最適化
- 複数の検索クエリを生成し、結果を統合する機能の実装
- 検索結果の関連性を評価し、再検索する機能の実装

### 8.3 レポート生成の最適化
- レポートのテンプレート化
- レポートの品質評価機能の実装

---

## 9. 更新履歴

- 2025-12-10: 初版作成
- 2025-12-10: レビュー反映（計測/運用/パフォーマンス/プロンプト方針を「長め優先＋上限時のみ縮約」に更新）
